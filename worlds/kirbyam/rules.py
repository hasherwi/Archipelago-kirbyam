"""Logic rules for Kirby & The Amazing Mirror.

This implementation is intentionally minimal while the world data model and
client/ROM integration are still in flux.

Current rules:
  - Access to the Dimension Mirror region requires collecting all 8 Mirror Shards
    (implemented as 8 progression items).
  - Completion conditions:
      * Dark Mind: have all 8 shards (placeholder until the client can signal
        boss defeat).
      * 100%: have all 8 shards (placeholder).
      * DEBUG: always completable.
"""

from __future__ import annotations

from typing import TYPE_CHECKING

from BaseClasses import CollectionState
from worlds.generic.Rules import set_rule

from .options import Goal

if TYPE_CHECKING:
    from . import KirbyAmWorld


_SHARD_ITEM_LABELS = [
    "Mustard Mountain - Mirror Shard",
    "Moonlight Mansion - Mirror Shard",
    "Candy Constellation - Mirror Shard",
    "Olive Ocean - Mirror Shard",
    "Peppermint Palace - Mirror Shard",
    "Cabbage Cavern - Mirror Shard",
    "Carrot Castle - Mirror Shard",
    "Radish Ruins - Mirror Shard",
]


def _has_all_shards(state: CollectionState, player: int) -> bool:
    return state.has_from_list_unique(_SHARD_ITEM_LABELS, player, len(_SHARD_ITEM_LABELS))


def set_rules(world: "KirbyAmWorld") -> None:
    # Completion condition
    if world.options.goal.value == Goal.option_debug:
        world.multiworld.completion_condition[world.player] = lambda _state: True
    else:
        # Placeholder until the client/ROM can create a real "defeat boss" signal.
        world.multiworld.completion_condition[world.player] = (
            lambda state: _has_all_shards(state, world.player)
        )

    # Region gating: the name is generated by regions.create_regions()
    entrance_name = "REGION_GAME_START -> REGION_DIMENSION_MIRROR/MAIN"
    try:
        entrance = world.multiworld.get_entrance(entrance_name, world.player)
        set_rule(entrance, lambda state: _has_all_shards(state, world.player))
    except Exception:
        # If the entrance doesn't exist yet (during early iteration), don't block generation.
        pass
